<!DOCTYPE html>
<html lang="en-us" />
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>Signatures - Reusable, Toolable, Testable Types &middot; Erlware Blog</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="canonical" href="/signatures-reusable-toolable-testable-types/" />

     <meta name="description" content="This tutorial is brought to you by ErlangCamp 2011 - Boston, August 12th and 13th - It&amp;rsquo;s gonna be totally sweet!
It often occurs in coding that we need a " /> 

     
    
    <meta name="twitter:card" content="summary"/>
    
 
    <meta name="twitter:title" content="Signatures - Reusable, Toolable, Testable Types"/>
    <meta name="twitter:description" content="This tutorial is brought to you by ErlangCamp 2011 - Boston, August 12th and 13th - It&amp;rsquo;s gonna be totally sweet!
It often occurs in coding that we need a "/>
    <meta name="twitter:url" content="/signatures-reusable-toolable-testable-types/" />
    <meta name="twitter:site" content="@"/>

    <meta property="og:site_name" content="Erlware Blog" />
    <meta property="og:title" content="Signatures - Reusable, Toolable, Testable Types &middot; Erlware Blog" />
    <meta property="og:url" content="/signatures-reusable-toolable-testable-types/" />
    

    <meta property="og:type" content="article" />
    <meta property="og:description" content="This tutorial is brought to you by ErlangCamp 2011 - Boston, August 12th and 13th - It&amp;rsquo;s gonna be totally sweet!
It often occurs in coding that we need a " />

    <meta property="article:published_time" content="2011-06-21T18:08:33Z" />
    


    <meta name="generator" content="Hugo 0.53" />

    <!-- Stylesheets -->
    <link rel="stylesheet" type="text/css" href="/built/screen.css" /> 
    <link rel="stylesheet" type="text/css" href="/css/casper-two.css" /> 
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" />
    

     

</head>


<body class="post-template">
  <div class="site-wrapper"> 

<header class="site-header outer">
  <div class="inner">
    <nav class="site-nav">
      <div class="site-nav-left">
        <a class="site-nav-logo" href="#"><img src="/img/logo.png" alt="Erlware Blog" /></a>

        <ul class="nav" role="menu">
        
        
        
            <li class="" role="menuitem">
              <a href="/">Home</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/about">About</a>
            </li>
        
      </ul></div>

      <div class="site-nav-right">
        <div class="social-links">
                    

                    

                    <a class="social-link" href="https://github.com/erlware" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>

                    

                    
        </div>  
            
      </div>

    </nav>  

  </div>
</header>

<main id="site-main" class="site-main outer" role="main">
  <div class="inner">
    
      <article class="post-full post"> 
    <header class="post-full-header">
        <section class="post-full-meta">
            <time class="post-full-meta-date" datetime="2011-06-21">21 June 2011</time>
        </section>
        <h1 class="post-full-title">Signatures - Reusable, Toolable, Testable Types</h1>
    </header>
    
    <figure class="post-full-image" style="background-image: url(/defimg/6.jpg)">
    </figure>

    <section class="post-full-content">
        <div class="kg-card-markdown">
        

<blockquote>
<p>This tutorial is brought to you by <a href="http://www.erlangcamp.com">ErlangCamp 2011</a> - Boston, August 12th and 13th - It&rsquo;s gonna be totally sweet!<br />
It often occurs in coding that we need a library, a set of functionality. Often there are several algorithms that could provide<br />
this functionality. However, the code that uses it, either doesn&rsquo;t care about the individual algorithm or wishes to delegate choosing that algorithm to some higher level. Lets take the concrete example of dictionaries. A dictionary provides the ability to access a value via a key (other things as well but primarily this). There are may ways to implement a dictionary. Just a few are:</p>
</blockquote>

<ul>
<li><a href="http://en.wikipedia.org/wiki/Associative_array">Associative Arrays</a><br /></li>
<li><a href="http://en.wikipedia.org/wiki/Binary_tree">Binary Trees</a><br /></li>
<li><a href="http://en.wikipedia.org/wiki/Hash_table#Performance_analysis">Hash Tables</a><br /></li>
<li><a href="http://en.wikipedia.org/wiki/Skip_list">Skip Lists</a><br /></li>
<li>Many, many more &hellip;.<br />
Each of these approaches has their own performance characteristics,  memory footprints etc. For example, a table of size n with open addressing has no collisions and holds up to n elements, with a single comparison for successful lookup, and a table of size n with chaining and k keys has the minimum max(0, k-n) collisions and O(1 + k/n) comparisons for lookup.  For skip lists the performance characteristics are about as good as that of randomly built binary search trees - namely (O log n). So the choice of which to select depends very much on memory available, insert/read characteristics, etc. So delegating the choice to a single point in your code is a very good idea. Unfortunately, in Erlang that&rsquo;s not so easy to do at the moment.<br />
<br /></li>
</ul>

<p>Other languages, have built-in support for this functionality. <a href="http://en.wikipedia.org/wiki/Java_(programming_language)">Java</a> has <a href="http://download.oracle.com/javase/tutorial/java/IandI/createinterface.html">Interfaces</a>, <a href="http://en.wikipedia.org/wiki/Standard_ML">SML</a> has <a href="http://en.wikipedia.org/wiki/Standard_ML#Module_system">Signatures</a>. Erlang, though, doesn&rsquo;t currently support this model, at least not directly. There are a few ways you can approximate it. One way is to pass the Module name to the calling functions along with the data that it is going to be called on.<br />
<div class="codehilite"><br />
<pre><span class="nf">add</span><span class="p">(</span><span class="nv">ModuleToUse</span><span class="p">,</span> <span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">,</span> <span class="nv">DictData</span><span class="p">)</span> <span class="o">-&gt;</span><br />
    <span class="nv">ModuleToUse</span><span class="p">:</span><span class="n">add</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">,</span> <span class="nv">DictData</span><span class="p">).</span></pre><br />
</div><br />
This works, and you can vary how you want to pass the data. For example, you could easily use a tuple to contain the data. That is, you could pass in <code>{ModuleToUse, DictData}</code> and that would make it a bit cleaner.<br />
<div class="codehilite"><br />
<pre><span class="nf">add</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">,</span> <span class="p">{</span><span class="nv">ModuleToUse</span><span class="p">,</span> <span class="nv">DictData</span><span class="p">})</span> <span class="o">-&gt;</span><br />
    <span class="nv">ModuleToUse</span><span class="p">:</span><span class="n">add</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">,</span> <span class="nv">DictData</span><span class="p">).</span></pre><br />
</div><br />
Either way, there are a few problems with this approach. One of the biggest is that you lose code locality, by looking at this bit of code you don&rsquo;t know what <code>ModuleToUse</code> is at all. You would need to follow the call chain up to figure out what it is. Also it may not be obvious what is actually happening. The fact that <code>ModuleToUse</code> is a variable name obscures the code making it harder to understand. The other big problem is that the tools provided with Erlang can&rsquo;t help find mistakes that you might have made. Tools like <a href="http://www.erlang.org/doc/man/xref.html">Xref</a> and <a href="http://www.erlang.org/doc/man/dialyzer.html">Dialyzer</a> have just as hard a time figuring out the what <code>ModuleToUse</code> is pointing to as you do. So they can&rsquo;t give you warnings about potential problems. In fact someone could inadvertently pass an unexpected function name as <code>ModuleToUse</code> and you would never get any warnings, just an exception at run time.</p>

<p>Fortunately, Erlang is a pretty flexible language so we can use a similar approach with a few adjustments to give us the best of both worlds. Both the flexibility of ignoring a specific implementation and keeping all the nice locality we get by using an explicit module name.</p>

<p>So what we actually want to do is something mole like this:<br />
<div class="codehilite"><br />
<pre><span class="nf">add</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">,</span> <span class="nv">DictData</span><span class="p">)</span> <span class="o">-&gt;</span><br />
    <span class="nn">dictionary</span><span class="p">:</span><span class="n">add</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">,</span> <span class="nv">DictData</span><span class="p">).</span></pre><br />
</div><br />
Doing this we retain the locality. We can easily look up the <code>dictionary</code> Module. We immediately have a good idea what a <code>dictionary</code> actually is and we know what functions we are calling. Also, all the tools know what a <code>dictionary</code> is as well and how to check that your code is calling it correctly. For all of these reasons, this is a much better approach to the problem. This is what <em>Signatures</em> are all about.</p>

<h2 id="signatures">Signatures</h2>

<p>How do we actually do this in Erlang when Erlang is missing what Java, SML and friends has built-in?</p>

<p>The first thing we need to do is to define a <a href="http://metajack.im/2008/10/29/custom-behaviors-in-erlang/">Behaviour</a> for our functionality. To continue our example we will define a Behaviour for dictionaries. That Behaviour looks like this:<br />
<div class="codehilite"><br />
<pre><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">ec_dictionary</span><span class="p">).</span></p>

<p><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">behaviour_info</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span></p>

<p><span class="nf">behaviour_info</span><span class="p">(</span><span class="n">callbacks</span><span class="p">)</span> <span class="o">-&gt;</span><br />
    <span class="p">[{</span><span class="n">new</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span><br />
     <span class="p">{</span><span class="n">has_key</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span><br />
     <span class="p">{</span><span class="nb">get</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span><br />
     <span class="p">{</span><span class="n">add</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span><br />
     <span class="p">{</span><span class="n">remove</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span><br />
     <span class="p">{</span><span class="n">has_value</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span><br />
     <span class="p">{</span><span class="nb">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span><br />
     <span class="p">{</span><span class="n">to_list</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span><br />
     <span class="p">{</span><span class="n">from_list</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span><br />
     <span class="p">{</span><span class="n">keys</span><span class="p">,</span> <span class="mi">1</span><span class="p">}];</span><br />
<span class="nf">behaviour<em>info</span><span class="p">(</em>)</span> <span class="o">-&gt;</span><br />
    <span class="n">undefined</span><span class="p">.</span></pre><br />
</div><br />
So we have our Behaviour now. Unfortunately, this doesn&rsquo;t give us much yet. It will make sure that any dictionaries we write will have all the functions they need, but it wont help us actually use those dictionaries in an abstract way in our code. To do that we need to add a bit of functionality. We do that by actually implementing our own behaviour, starting with <code>new/1</code>.<br />
<div class="codehilite"><br />
<pre><span class="c">%% @doc create a new dictionary object from the specified module. The</span><br />
<span class="c">%% module should implement the dictionary behaviour.</span><br />
<span class="c">%%</span><br />
<span class="c">%% @param ModuleName The module name.</span><br />
<span class="p">-</span><span class="ni">spec</span> <span class="n">new</span><span class="p">(</span><span class="n">module</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="n">dictionary</span><span class="p">(<em></span><span class="nv">K</span><span class="p">,</span> <span class="p"></em></span><span class="nv">V</span><span class="p">).</span><br />
<span class="nf">new</span><span class="p">(</span><span class="nv">ModuleName</span><span class="p">)</span> <span class="k">when</span> <span class="nb">is_atom</span><span class="p">(</span><span class="nv">ModuleName</span><span class="p">)</span> <span class="o">-&gt;</span><br />
    <span class="nl">#dict_t</span><span class="p">{</span><span class="n">callback</span> <span class="o">=</span> <span class="nv">ModuleName</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="nv">ModuleName</span><span class="p">:</span><span class="n">new</span><span class="p">()}.</span></pre><br />
</div><br />
This code creates a new dictionary for us. Or to be more specific it actually creates a new dictionary Signature record, that will be used subsequently in other calls. This might look a bit familiar from our previous less optimal approach. We have both the module name and the data. here in the record. We call the module name named in <code>ModuleName</code> to create the initial data. We then construct the record and return that record to the caller and we have a new dictionary. What about the other functions; the ones that don&rsquo;t create a dictionary but make use of it. Let&rsquo;s take a look at the implementations of two kinds of functions, one that updates the dictionary and another that just retrieves data.</p>

<p>The first we will look at is the one that updates the dictionary by adding a value.<br />
<div class="codehilite"><br />
<pre><span class="c">%% @doc add a new value to the existing dictionary. Return a new</span><br />
<span class="c">%% dictionary containing the value.</span><br />
<span class="c">%%</span><br />
<span class="c">%% @param Dict the dictionary object to add too</span><br />
<span class="c">%% @param Key the key to add</span><br />
<span class="c">%% @param Value the value to add</span><br />
<span class="p">-</span><span class="ni">spec</span> <span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">(</span><span class="nv">K</span><span class="p">),</span> <span class="n">value</span><span class="p">(</span><span class="nv">V</span><span class="p">),</span> <span class="n">dictionary</span><span class="p">(</span><span class="nv">K</span><span class="p">,</span> <span class="nv">V</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">dictionary</span><span class="p">(</span><span class="nv">K</span><span class="p">,</span> <span class="nv">V</span><span class="p">).</span><br />
<span class="nf">add</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">,</span> <span class="nl">#dict_t</span><span class="p">{</span><span class="n">callback</span> <span class="o">=</span> <span class="nv">Mod</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="nv">Data</span><span class="p">}</span> <span class="o">=</span> <span class="nv">Dict</span><span class="p">)</span> <span class="o">-&gt;</span><br />
    <span class="nv">Dict</span><span class="nl">#dict_t</span><span class="p">{</span><span class="n">data</span> <span class="o">=</span> <span class="nv">Mod</span><span class="p">:</span><span class="n">add</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">,</span> <span class="nv">Data</span><span class="p">)}.</span></pre><br />
</div><br />
There are two key things here.</p>

<ol>
<li>The dictionary is deconstructed so we can get access to the data<br />
and the callback module.<br /></li>
<li>We modify the dictionary record with the new data and return that<br />
modified record.<br />
This is the same approach that you will use for any Signature that updates data. As a side note, notice that we are calling the concrete implementation to do the work itself.<br />
<br /></li>
</ol>

<p>Now let&rsquo;s do a data retrieval function. In this case, the <code>get</code> function of the dictionary Signature.<br />
<div class="codehilite"><br />
<pre><span class="c">%% @doc given a key return that key from the dictionary. If the key is</span><br />
<span class="c">%% not found throw a &lsquo;not_found&rsquo; exception.</span><br />
<span class="c">%%</span><br />
<span class="c">%% @param Dict The dictionary object to return the value from</span><br />
<span class="c">%% @param Key The key requested</span><br />
<span class="c">%% @throws not_found when the key does not exist</span><br />
<span class="p">-</span><span class="ni">spec</span> <span class="nb">get</span><span class="p">(</span><span class="n">key</span><span class="p">(</span><span class="nv">K</span><span class="p">),</span> <span class="n">dictionary</span><span class="p">(</span><span class="nv">K</span><span class="p">,</span> <span class="nv">V</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">value</span><span class="p">(</span><span class="nv">V</span><span class="p">).</span><br />
<span class="nb">get</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nl">#dict_t</span><span class="p">{</span><span class="n">callback</span> <span class="o">=</span> <span class="nv">Mod</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="nv">Data</span><span class="p">})</span> <span class="o">-&gt;</span><br />
    <span class="nv">Mod</span><span class="p">:</span><span class="nb">get</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Data</span><span class="p">).</span></pre><br />
</div><br />
In this case, you can see a very similar approach to deconstructing the dict record. We still need to pull out the callback module and the data itself and call the concrete implementation of the algorithm. In this case, we return the data returned from the call, not the record itself.</p>

<p>That is really all you need to define a Signature. There is a complete implementation in <a href="https://github.com/ericbmerritt/erlware_commons/blob/next/src/ec_dictionary.erl">erlware_commons/ec_dictionary</a>.</p>

<h2 id="using-signatures">Using Signatures</h2>

<p>It&rsquo;s a good idea to work through an example so we have a bit better idea of how to use these Signatures. If you are like me, you probably have some questions about what kind of performance burden this places on the code. At the very least we have an additional function call along with the record deconstruction. This must add some overhead. So lets write a little timing test, so we can get a good idea of how much this is all costing us.</p>

<p>In general, there are two kinds of concrete implementations for Signatures. The first is a native implementations, the second is a<br />
wrapper.</p>

<h3 id="native-signature-implementations">Native Signature Implementations</h3>

<p>A Native Signature Implementation is just that, a module that implements the Behaviour defined by a Signature directly. For most user defined Signatures this is going to be the norm. In our current example, the <a href="https://github.com/ericbmerritt/erlware_commons/blob/next/src/ec_rbdict.erl">erlware_commons/ec_rbdict</a> module is the best example of a Native Signature Implementation. It implements the ec_dictionary module directly.</p>

<h3 id="signature-wrappers">Signature Wrappers</h3>

<p>A Signature Wrapper is a module that wraps another module. Its purpose is to help a pre-existing module implement the Behaviour defined by a Signature. A good example of this in our current example is the <a href="https://github.com/ericbmerritt/erlware_commons/blob/next/src/ec_dict.erl">erlware_commons/ec_dict</a> module. It implements the ec_dictionary Behaviour, but all the functionality is provided by the <a href="http://www.erlang.org/doc/man/dict.html">stdlib/dict</a> module itself. Lets take a look at one example to see how this is done.</p>

<p>We will take a look at one of the functions we have already seen. The <code>get</code> function an ec_dictionary <code>get</code> doesn&rsquo;t have quite the same semantics as any of the functions in the dict module. So a bit of translation needs to be done. We do that in the ec_dict module <code>get</code> function.<br />
<div class="codehilite"><br />
<pre><span class="p">-</span><span class="ni">spec</span> <span class="nb">get</span><span class="p">(</span><span class="nn">ec_dictionary</span><span class="p">:</span><span class="n">key</span><span class="p">(</span><span class="nv">K</span><span class="p">),</span> <span class="nv">Object</span><span class="p">::</span><span class="n">dictionary</span><span class="p">(</span><span class="nv">K</span><span class="p">,</span> <span class="nv">V</span><span class="p">))</span> <span class="o">-&gt;</span><br />
           <span class="nn">ec_dictionary</span><span class="p">:</span><span class="n">value</span><span class="p">(</span><span class="nv">V</span><span class="p">).</span><br />
<span class="nb">get</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Data</span><span class="p">)</span> <span class="o">-&gt;</span><br />
    <span class="k">case</span> <span class="nn">dict</span><span class="p">:</span><span class="n">find</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Data</span><span class="p">)</span> <span class="k">of</span><br />
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Value</span><span class="p">}</span> <span class="o">-&gt;</span><br />
        <span class="nv">Value</span><span class="p">;</span><br />
     <span class="n">error</span> <span class="o">-&gt;</span><br />
        <span class="n">throw</span><span class="p">(</span><span class="n">not_found</span><span class="p">)</span><br />
    <span class="k">end</span><span class="p">.</span></pre><br />
</div><br />
So the ec_dict module&rsquo;s purpose for existence is to help the preexisting dict module implement the Behaviour defined by the Signature.</p>

<p>Why do we bring this up here? Because we are going to be looking at timings, and Signature Wrappers add an extra level of indirection to the mix and that adds a bit of additional overhead.</p>

<h3 id="creating-the-timing-module">Creating the Timing Module</h3>

<p>We are going to create timings for both Native Signature Implementations and Signature Wrappers.</p>

<p>Lets get started by looking at some helper functions. We want dictionaries to have a bit of data in them. So to that end we will create a couple of functions that create dictionaries for each type we want to test. The first we want to time is the Signature Wrapper, so <code>dict</code> vs <code>ec_dict</code> called as a Signature.<br />
<div class="codehilite"><br />
<pre><span class="nf">create_dict</span><span class="p">()</span> <span class="o">-&gt;</span><br />
<span class="nn">lists</span><span class="p">:</span><span class="n">foldl</span><span class="p">(</span><span class="k">fun</span><span class="p">(</span><span class="nv">El</span><span class="p">,</span> <span class="nv">Dict</span><span class="p">)</span> <span class="o">-&gt;</span><br />
        <span class="nn">dict</span><span class="p">:</span><span class="n">store</span><span class="p">(</span><span class="nv">El</span><span class="p">,</span> <span class="nv">El</span><span class="p">,</span> <span class="nv">Dict</span><span class="p">)</span><br />
    <span class="k">end</span><span class="p">,</span> <span class="nn">dict</span><span class="p">:</span><span class="n">new</span><span class="p">(),</span><br />
    <span class="nn">lists</span><span class="p">:</span><span class="n">seq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">)).</span></pre><br />
</div><br />
The only thing we do here is create a sequence of numbers 1 to 100, and then add each of those to the dict as an entry. We aren&rsquo;t too worried about replicating real data in the dictionary. We care about timing the function call overhead of Signatures, not the performance of the dictionaries themselves.</p>

<p>We need to create a similar function for our Signature based dictionary <code>ec_dict</code>.<br />
<div class="codehilite"><br />
<pre><span class="nf">create_dictionary</span><span class="p">(</span><span class="nv">Type</span><span class="p">)</span> <span class="o">-&gt;</span><br />
<span class="nn">lists</span><span class="p">:</span><span class="n">foldl</span><span class="p">(</span><span class="k">fun</span><span class="p">(</span><span class="nv">El</span><span class="p">,</span> <span class="nv">Dict</span><span class="p">)</span> <span class="o">-&gt;</span><br />
        <span class="nn">ec_dictionary</span><span class="p">:</span><span class="n">add</span><span class="p">(</span><span class="nv">El</span><span class="p">,</span> <span class="nv">El</span><span class="p">,</span> <span class="nv">Dict</span><span class="p">)</span><br />
    <span class="k">end</span><span class="p">,</span><br />
    <span class="nn">ec_dictionary</span><span class="p">:</span><span class="n">new</span><span class="p">(</span><span class="nv">Type</span><span class="p">),</span><br />
    <span class="nn">lists</span><span class="p">:</span><span class="n">seq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">)).</span></pre><br />
</div><br />
Here we actually create everything using the Signature. So we don&rsquo;t need one function for each type. We can have one function that can create anything that implements the Signature. That is the magic of Signatures. Otherwise, this does the exact same thing as the dict <code>create_dict/1</code>.</p>

<p>We are going to use two function calls in our timing. One that updates data and one that returns data, just to get good coverage. For our dictionaries we are going to use the <code>size</code> function as well as the <code>add</code> function.<br />
<div class="codehilite"><br />
<pre><span class="nf">time_direct_vs_signature_dict</span><span class="p">()</span> <span class="o">-&gt;</span><br />
    <span class="nn">io</span><span class="p">:</span><span class="n">format</span><span class="p">(</span><span class="s">&ldquo;Timing dict</span><span class="si">~n</span><span class="s">&ldquo;</span><span class="p">),</span><br />
    <span class="nv">Dict</span> <span class="o">=</span> <span class="n">create_dict</span><span class="p">(),</span><br />
    <span class="n">test_avg</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span><br />
             <span class="nn">dict</span><span class="p">:</span><span class="nb">size</span><span class="p">(</span><span class="nn">dict</span><span class="p">:</span><span class="n">store</span><span class="p">(</span><span class="n">some_key</span><span class="p">,</span> <span class="n">some_value</span><span class="p">,</span> <span class="nv">Dict</span><span class="p">))</span><br />
         <span class="k">end</span><span class="p">,</span><br />
         <span class="mi">1000000</span><span class="p">),</span><br />
    <span class="nn">io</span><span class="p">:</span><span class="n">format</span><span class="p">(</span><span class="s">&ldquo;Timing ec_dict implementation of ec_dictionary</span><span class="si">~n</span><span class="s">&ldquo;</span><span class="p">),</span><br />
    <span class="n">time_dict_type</span><span class="p">(</span><span class="n">ec_dict</span><span class="p">).</span></pre><br />
</div><br />
The <code>test_avg</code> function runs the provided function the number of times specified in the second argument and collects timing information. We are going to run these one million times to get a good average (its fast so it doesn&rsquo;t take long). You can see that in the anonymous function that we directly call <code>dict:size/1</code> and <code>dict:store/3</code> to perform the test. However, because we are in the wonderful world of Signatures we don&rsquo;t have to hard code the calls for the Signature implementations. Lets take a look at the <code>time_dict_type</code> function.<br />
<div class="codehilite"><br />
<pre><span class="nf">time_dict_type</span><span class="p">(</span><span class="nv">Type</span><span class="p">)</span> <span class="o">-&gt;</span><br />
    <span class="nn">io</span><span class="p">:</span><span class="n">format</span><span class="p">(</span><span class="s">&ldquo;Testing </span><span class="si">~p~n</span><span class="s">&ldquo;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Type</span><span class="p">]),</span><br />
    <span class="nv">Dict</span> <span class="o">=</span> <span class="n">create_dictionary</span><span class="p">(</span><span class="nv">Type</span><span class="p">),</span><br />
    <span class="n">test_avg</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span><br />
         <span class="nn">ec_dictionary</span><span class="p">:</span><span class="nb">size</span><span class="p">(</span><span class="nn">ec_dictionary</span><span class="p">:</span><span class="n">add</span><span class="p">(</span><span class="n">some_key</span><span class="p">,</span> <span class="n">some_value</span><span class="p">,</span> <span class="nv">Dict</span><span class="p">))</span><br />
         <span class="k">end</span><span class="p">,</span><br />
         <span class="mi">1000000</span><span class="p">).</span></pre><br />
</div><br />
As you can see we take the type as an argument (we need it for <code>dict </code>creation) and call our create function. Then we run the same timings that we did for ec dict. In this case though, the type of dictionary is never specified, we only ever call ec_dictionary, so this test will work for anything that implements that Signature.</p>

<h4 id="dict-vs-ec-dict-results"><code>dict</code> vs <code>ec_dict</code> Results</h4>

<p>So we have our tests, what was the result. Well on my laptop this is what it looked like.<br />
<div class="codehilite"><br />
<pre>Erlang R14B01 <span class="o">(</span>erts-5.8.2<span class="o">)</span> <span class="o">[</span><span class="nb">source</span><span class="o">]</span> <span class="o">[</span>64-bit<span class="o">]</span> <span class="o">[</span>smp:4:4<span class="o">]</span> <span class="o">[</span>rq:4<span class="o">]</span> <span class="o">[</span>async-threads:0<span class="o">]</span> <span class="o">[</span>hipe<span class="o">]</span> <span class="o">[</span>kernel-poll:false<span class="o">]</span></p>

<p>Eshell V5.8.2  <span class="o">(</span>abort with ^G<span class="o">)</span></p>

<p>1&gt; ec_timing:time_direct_vs_signature_dict<span class="o">()</span>.<br />
Timing dict<br />
Range: 2 - 5621 mics<br />
Median: 3 mics<br />
Average: 3 mics<br />
Timing ec_dict implementation of ec_dictionary<br />
Testing ec_dict<br />
Range: 3 - 6097 mics<br />
Median: 3 mics<br />
Average: 4 mics<br />
2&gt;</pre><br />
</div><br />
So for the direct dict call, we average about 3 mics per call, while for the Signature Wrapper we average around 4. Thats a 25% cost for Signature Wrappers in this example, for a very small number of calls. Depending on what you are doing that is going to be greater or lesser. In any case, we can see that there is some cost associated with the Signature Wrapper Implementations.</p>

<p>What about native Signatures though? Lets take a look at <code>ec_rbdict</code>. The <code>ec_rbdict</code> also implements the <code>ec_dictionary </code>Signature, but it is not a Signature Wrapper. It is a native implementation of the Signature. To use <code>ec_rbdict</code> directly we have to create a creation helper just like we did for dict.<br />
<div class="codehilite"><br />
<pre><span class="nf">create_rbdict</span><span class="p">()</span> <span class="o">-&gt;</span><br />
<span class="nn">lists</span><span class="p">:</span><span class="n">foldl</span><span class="p">(</span><span class="k">fun</span><span class="p">(</span><span class="nv">El</span><span class="p">,</span> <span class="nv">Dict</span><span class="p">)</span> <span class="o">-&gt;</span><br />
        <span class="nn">ec_rbdict</span><span class="p">:</span><span class="n">add</span><span class="p">(</span><span class="nv">El</span><span class="p">,</span> <span class="nv">El</span><span class="p">,</span> <span class="nv">Dict</span><span class="p">)</span><br />
    <span class="k">end</span><span class="p">,</span> <span class="nn">ec_rbdict</span><span class="p">:</span><span class="n">new</span><span class="p">(),</span><br />
    <span class="nn">lists</span><span class="p">:</span><span class="n">seq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">)).</span></pre><br />
</div><br />
This is exactly the same as <code>create_dict</code> with the exception that dict is replaced by <code>ec_rbdict</code>.</p>

<p>The timing function itself looks very similar as well. Again notice that we have to hard code the concrete name for the concrete<br />
implementation, but we don&rsquo;t for the ec_dictionary test.<br />
<div class="codehilite"><br />
<pre><span class="nf">time_direct_vs_signature_rbdict</span><span class="p">()</span> <span class="o">-&gt;</span><br />
    <span class="nn">io</span><span class="p">:</span><span class="n">format</span><span class="p">(</span><span class="s">&ldquo;Timing rbdict</span><span class="si">~n</span><span class="s">&ldquo;</span><span class="p">),</span><br />
    <span class="nv">Dict</span> <span class="o">=</span> <span class="n">create_rbdict</span><span class="p">(),</span><br />
    <span class="n">test_avg</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span><br />
         <span class="nn">ec_rbdict</span><span class="p">:</span><span class="nb">size</span><span class="p">(</span><span class="nn">ec_rbdict</span><span class="p">:</span><span class="n">add</span><span class="p">(</span><span class="n">some_key</span><span class="p">,</span> <span class="n">some_value</span><span class="p">,</span> <span class="nv">Dict</span><span class="p">))</span><br />
         <span class="k">end</span><span class="p">,</span><br />
         <span class="mi">1000000</span><span class="p">),</span><br />
   <span class="nn">io</span><span class="p">:</span><span class="n">format</span><span class="p">(</span><span class="s">&ldquo;Timing ec_dict implementation of ec_dictionary</span><span class="si">~n</span><span class="s">&ldquo;</span><span class="p">),</span><br />
   <span class="n">time_dict_type</span><span class="p">(</span><span class="n">ec_rbdict</span><span class="p">).</span></pre><br />
</div><br />
And there we have our test. What do the results look like?</p>

<h4 id="ec-dict-vs-ec-rbdict-as-an-ec-dictionary-results"><code>ec_dict</code> vs <code>ec_rbdict</code> as an <code>ec_dictionary</code> Results</h4>

<p>The main thing we are timing here is the additional cost of the dictionary Signature itself. Keep that in mind as we look at the<br />
results.<br />
<div class="codehilite"><br />
<pre>Erlang R14B01 <span class="o">(</span>erts-5.8.2<span class="o">)</span> <span class="o">[</span><span class="nb">source</span><span class="o">]</span> <span class="o">[</span>64-bit<span class="o">]</span> <span class="o">[</span>smp:4:4<span class="o">]</span> <span class="o">[</span>rq:4<span class="o">]</span> <span class="o">[</span>async-threads:0<span class="o">]</span> <span class="o">[</span>hipe<span class="o">]</span> <span class="o">[</span>kernel-poll:false<span class="o">]</span></p>

<p>Eshell V5.8.2  <span class="o">(</span>abort with ^G<span class="o">)</span></p>

<p>1&gt; ec_timing:time_direct_vs_signature_rbdict<span class="o">()</span>.<br />
Timing rbdict<br />
Range: 6 - 15070 mics<br />
Median: 7 mics<br />
Average: 7 mics<br />
Timing ec_dict implementation of ec_dictionary<br />
Testing ec_rbdict<br />
Range: 6 - 6013 mics<br />
Median: 7 mics<br />
Average: 7 mics<br />
2&gt;</pre><br />
</div><br />
So no difference it time. Well the reality is that there is a difference in timing, there must be, but we don&rsquo;t have enough resolution in the timing system to be able to figure out what that difference is. Essentially that means it&rsquo;s really, really small - or small enough not to worry about at the very least.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Signatures are a viable, useful approach to the problem of interfaces in Erlang. The have little or no over head depending on the type of implementation, and greatly increase the flexibility of the a library while retaining testability and locality.</p>

<h3 id="terminology">Terminology</h3>

<dl>
<dt>Behaviour<br /></dt>
<dd>A normal Erlang Behaviour that defines a contract<br />
<br /></dd>
<dt>Signature<br /></dt>
<dd>A combination of an Behaviour and functionality to make the functions callable in a concrete way<br />
<br /></dd>
<dt>Native Signature Implementation<br /></dt>
<dd>A module that implements a signature directly<br />
<br /></dd>
<dt>Signature Wrapper<br /></dt>
<dd>A module that does translation between a preexisting module and a Signature, allowing the preexisting module to be used as a Signature Implementation.<br />
<br /></dd>
</dl>

<h3 id="code-referenced">Code Referenced</h3>

<ul>
<li><a href="https://github.com/ericbmerritt/erlware_commons/blob/next/src/ec_dictionary.erl">ec_dictionary Signature Wrapper</a><br /></li>
<li><a href="https://github.com/ericbmerritt/erlware_commons/blob/next/src/ec_dict.erl">ec_dict Signature Implementation</a><br /></li>
<li><a href="https://github.com/ericbmerritt/erlware_commons/blob/next/src/ec_rbdict.erl">ec_rbdict Native Signature Implementation</a><br /></li>
<li><a href="https://github.com/ericbmerritt/erlware_commons/blob/next/examples/ec_timing.erl">ec_timing Signature Use Example and Timing Collector</a></li>
</ul>
    
        </div>
    </section>

    <footer class="post-full-footer">
      <section class="author-card">
        <img class="author-profile-image" src="/" alt="Author" />
        <section class="author-card-content">
            <h4 class="author-card-name"><a href="/">Tristan Sloughter</a></h4>
                <p></p>
        </section>
      </section>
    </footer>
</article>
    
    
    

  </div>
</main>


<aside class="read-next outer">
  <div class="inner">
    <div class="read-next-feed">      
      

      
      
    </div>
  </div>
</aside>

<div class="floating-header">
  <div class="floating-header-logo">
    <a href="/">
      <img src="/img/logo.png" alt="Erlware Blog" />
      <span>Erlware Blog</span>
    </a>
  </div>
  <span class="floating-header-divider">&mdash;</span>
  <div class="floating-header-title">Signatures - Reusable, Toolable, Testable Types</div>
  <div class="floating-header-share">
    <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
     <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/></svg>
    </div>
    
    <a class="floating-header-share-tw" href="https://twitter.com/share?text=Signatures%20-%20Reusable%2c%20Toolable%2c%20Testable%20Types&amp;url=%2fsignatures-reusable-toolable-testable-types%2f"
          onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
      </a>
      <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=%2fsignatures-reusable-toolable-testable-types%2f"
          onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>
      </a>
  </div>

  <progress class="progress" value="0">
    <div class="progress-container">
      <span class="progress-bar"></span>
    </div>
  </progress>
</div>



<footer class="site-footer outer">
  <div class="site-footer-content inner">
    <section class="copyright" style="line-height: 1.3em;">
      <a href="/"></a>  <br>
      
    </section>
    <nav class="site-footer-nav">
        <a href="/">Latest Posts</a>
        
        
        <a href="https://github.com/erlware" target="_blank" rel="noopener">Github</a>
        
        
    </nav>  
  </div>
</footer>

</div>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script type="text/javascript" src="//code.jquery.com/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="/js/jquery.fitvids.js"></script>

<script>hljs.initHighlightingOnLoad();</script>



    <script>





$(document).ready(function () {
    
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>
</body></html>
