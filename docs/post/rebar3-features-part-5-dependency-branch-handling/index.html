<!DOCTYPE html>
<html lang="en-us" />
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>Rebar3 Features (part 5): Dependency Tracking &middot; Erlware Blog</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/blog.erlware.org/favicon.ico" />
    <link rel="canonical" href="/blog.erlware.org/post/rebar3-features-part-5-dependency-branch-handling/" />

     <meta name="description" content="When starting rebar3 a goal was to never again end up in a situation where rm -rf deps to get the right set of dependencies was the quickest or only way forward" /> 

     
    
    <meta name="twitter:card" content="summary"/>
    
 
    <meta name="twitter:title" content="Rebar3 Features (part 5): Dependency Tracking"/>
    <meta name="twitter:description" content="When starting rebar3 a goal was to never again end up in a situation where rm -rf deps to get the right set of dependencies was the quickest or only way forward"/>
    <meta name="twitter:url" content="/blog.erlware.org/post/rebar3-features-part-5-dependency-branch-handling/" />
    <meta name="twitter:site" content="@"/>

    <meta property="og:site_name" content="Erlware Blog" />
    <meta property="og:title" content="Rebar3 Features (part 5): Dependency Tracking &middot; Erlware Blog" />
    <meta property="og:url" content="/blog.erlware.org/post/rebar3-features-part-5-dependency-branch-handling/" />
    

    <meta property="og:type" content="article" />
    <meta property="og:description" content="When starting rebar3 a goal was to never again end up in a situation where rm -rf deps to get the right set of dependencies was the quickest or only way forward" />

    <meta property="article:published_time" content="2015-09-21T19:24:21Z" />
    <meta property="article:tag" content="Erlang" /><meta property="article:tag" content="rebar3" />


    <meta name="generator" content="Hugo 0.53" />

    <!-- Stylesheets -->
    <link rel="stylesheet" type="text/css" href="/blog.erlware.org/built/screen.css" /> 
    <link rel="stylesheet" type="text/css" href="/blog.erlware.org/css/casper-two.css" /> 
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" />
    

     

</head>


<body class="ctsingle">

  <div class="site-wrapper"> 

<header class="site-header outer "  >
  <div class="inner">
    <div class="site-header-content">
      <h1 class="site-title">
        <img class="site-logo" src="/blog.erlware.org/img/logo.png" alt="Erlware Blog" />
       </h1>
        <h2 class="site-description">Erlang tools and packaging </h2>
    </div>

    <nav class="site-nav">
      <div class="site-nav-left"><ul class="nav" role="menu">
        
        
        
            <li class="" role="menuitem">
              <a href="/blog.erlware.org/">Home</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/blog.erlware.org/about">About</a>
            </li>
        
      </ul></div>

      <div class="site-nav-right">
        <div class="social-links">
                    

                    

                    <a class="social-link" href="https://github.com/erlware" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>

                    

                    
        </div>  
            
      </div>

    </nav>  

  </div>
</header>


<main id="site-main" class="site-main outer" role="main">
  <div class="inner">
    
    <div class="post-feed">
      <article class="post-card post"> 
    
    <a class="post-card-image-link" href="/blog.erlware.org/post/rebar3-features-part-5-dependency-branch-handling/">
      <div class="post-card-image" style="background-image: url(/blog.erlware.org/defimg/1.jpg)"></div>
    </a>    
    

    <div class="post-card-content">
      <a class="post-card-content-link" href="/blog.erlware.org/post/rebar3-features-part-5-dependency-branch-handling/">
          <header class="post-card-header">
              <span class="post-card-tags">
              #Erlang 
              #rebar3  </span>
              
              <h2 class="post-card-title">Rebar3 Features (part 5): Dependency Tracking</h2>
          </header>
      </a>
      <section class="post-card-excerpt" style="padding: 0 25px;">
          <p>When starting rebar3 a goal was to never again end up in a situation where <code>rm -rf deps</code> to get the right set of dependencies was the quickest or only way forward.</p>

<p>An important piece of this is the new and improved <a href="http://www.rebar3.org/docs/dependencies#upgrading-dependencies">upgrade command</a>. However, this post will cover a less visible (it isn&rsquo;t a new command) improvement related to how rebar3 fetches and tracks dependencies each time the <code>compile</code> command is run.</p>

<p>Since there is no <code>get-deps</code> command, each time <code>compile</code> is run it relies on a task that verifies all dependencies are fetched and available in the appropriate build directory (specific to the profiles being used). Every resource type (<code>pkg</code>, <code>git</code>, <code>hg</code> and possibly <a href="http://www.rebar3.org/docs/custom-dep-resources">third party types</a>) implements the behaviour <code>rebar_resource</code> which includes the function <code>needs_update/2</code>. If the application is found to exist already during the dependency verification phase and is in the lock file rebar3 then uses <code>needs_update/2</code> to check, unique to the resource type, if it is consistent with what is expected based on the lock file. If not, the source in the lock is fetched and replaces the current application.</p>

<p>An example project <a href="https://github.com/tsloughter/dep_tracking">dep_tracking</a> has been created to show what this looks like when switching branches in a project that has differing dependencies between the branches. In this example the <code>master</code> branch depends on <code>cowboy</code> <code>1.0.3</code> and a branch <code>http2</code> depends on <code>cowboy</code> <code>master</code> where HTTP/2 support is being added. Just to show this doesn&rsquo;t change how transitive dependencies are handled, <code>ranch</code> has been added to the deps list as well, as a package <code>1.0.0</code> in <code>master</code> and <code>1.1.0</code> in <code>http2</code>.</p>

<p>Clone the repository and build as usual:</p>

<pre><code>$ git clone https://github.com/tsloughter/dep_tracking
$ cd dep_tracking/
(master) $ cat rebar.lock
[{&lt;&lt;&quot;cowboy&quot;&gt;&gt;,
  {git,&quot;https://github.com/ninenines/cowboy.git&quot;,
       {ref,&quot;b8e4115eb13488c517d8d8ef33c47d0eaa7838c6&quot;}},
  0},
 {&lt;&lt;&quot;cowlib&quot;&gt;&gt;,
  {git,&quot;https://github.com/ninenines/cowlib.git&quot;,
       {ref,&quot;d544a494af4dbc810fc9c15eaf5cc050cced1501&quot;}},
  1},
 {&lt;&lt;&quot;ranch&quot;&gt;&gt;,{pkg,&lt;&lt;&quot;ranch&quot;&gt;&gt;,&lt;&lt;&quot;1.0.0&quot;&gt;&gt;},0}].
(master) $ rebar3 compile
 ===&gt; Verifying dependencies...
===&gt; Fetching cowboy ({git,&quot;https://github.com/ninenines/cowboy.git&quot;,{ref,&quot;b8e4115eb13488c517d8d8ef33c47d0eaa7838c6&quot;}})
===&gt; Fetching ranch ({pkg,&lt;&lt;&quot;ranch&quot;&gt;&gt;,&lt;&lt;&quot;1.0.0&quot;&gt;&gt;})
===&gt; Version cached at ~/.cache/rebar3/hex/default/packages/ranch-1.0.0.tar is up to date, reusing it
===&gt; Fetching cowlib ({git,&quot;https://github.com/ninenines/cowlib.git&quot;,{ref,&quot;d544a494af4dbc810fc9c15eaf5cc050cced1501&quot;}})
===&gt; Compiling cowlib
===&gt; Compiling ranch
===&gt; Compiling cowboy
===&gt; Compiling dep_tracking
</code></pre>

<p>Notice that in the case of a package (a <a href="https://hex.pm">hex.pm</a> package to be specific) if a copy has already been fetched before, for any project, it is cached and will be reused instead of re-downloading, like in the case of git dependencies.</p>

<p>Now, even though all dependencies have been fetched and built, switching branches to the <code>http2</code> branch and running <code>compile</code> again will fetch the new versions of the dependencies that need updating and compile them:</p>

<pre><code>(master) $ git checkout http2
(http2) $ cat rebar.lock
[{&lt;&lt;&quot;cowboy&quot;&gt;&gt;,
  {git,&quot;https://github.com/ninenines/cowboy.git&quot;,
       {ref,&quot;0ffde50991502ed222005376a66791debc4b991c&quot;}},
  0},
 {&lt;&lt;&quot;cowlib&quot;&gt;&gt;,
  {git,&quot;https://github.com/ninenines/cowlib.git&quot;,
       {ref,&quot;14e597baa42a436469f99661ed7994685e269dc2&quot;}},
  1},
 {&lt;&lt;&quot;ranch&quot;&gt;&gt;,{pkg,&lt;&lt;&quot;ranch&quot;&gt;&gt;,&lt;&lt;&quot;1.1.0&quot;&gt;&gt;},0}].
(http2) $ rebar3 compile
===&gt; Verifying dependencies...
===&gt; Upgrading cowboy({git,&quot;https://github.com/ninenines/cowboy.git&quot;,{ref,&quot;0ffde50991502ed222005376a66791debc4b991c&quot;}})
===&gt; Upgrading ranch ({pkg,&lt;&lt;&quot;ranch&quot;&gt;&gt;,&lt;&lt;&quot;1.1.0&quot;&gt;&gt;})
===&gt; Version cached at ~/.cache/rebar3/hex/default/packages/ranch-1.1.0.tar is up to date, reusing it
===&gt; Upgrading cowlib ({git,&quot;https://github.com/ninenines/cowlib.git&quot;,{ref,&quot;14e597baa42a436469f99661ed7994685e269dc2&quot;}})
===&gt; Compiling cowlib
===&gt; Compiling ranch
===&gt; Compiling cowboy
===&gt; Compiling dep_tracking
</code></pre>

<p>Rebar3 ensures the correct dependencies are fetched and built, simplifying working on different feature branches of your project or updating a branch with the upstream repository, without requiring any manual intervention.</p>

<p>May <code>rm -rf deps</code> be forever expunged from the vocabulary of free developers!</p>

      </section>

      <footer class="post-card-meta">
          <img class="author-profile-image" src="/blog.erlware.org/" alt="Author" />
          <span class="post-card-author"><a href="/">Tristan Sloughter</a></span>
      </footer>
    </div>
</article>
    </div>

    <nav class="pagination" role="navigation">
      
          <a class="newer-posts" href="/blog.erlware.org/post/rebar3-auto-comile-and-load-plugin/">&larr; <span class="hide">Next Post</span></a>
      
      <span class="page-number">&nbsp;</span>
      
          <a class="older-posts" href="/blog.erlware.org/post/rebar3-features-part-4-profiles/"><span class="hide">Previous Post</span> &rarr;</a>
      
    </nav>

    
    
    

  </div>
</main>



<footer class="site-footer outer">
  <div class="site-footer-content inner">
    <section class="copyright" style="line-height: 1.3em;">
      <a href="/"></a>  <br>
      
    </section>
    <nav class="site-footer-nav">
        <a href="/">Latest Posts</a>
        
        
        <a href="https://github.com/erlware" target="_blank" rel="noopener">Github</a>
        
        
    </nav>  
  </div>
</footer>

</div>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script type="text/javascript" src="//code.jquery.com/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="/blog.erlware.org/js/jquery.fitvids.js"></script>

<script>hljs.initHighlightingOnLoad();</script>




</body></html>
