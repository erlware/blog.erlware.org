<!DOCTYPE html>
<html lang="en-us" />
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>eCloudEdit: Erlang, Webmachine and Backbone.js &middot; Erlware Blog</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/blog.erlware.org/favicon.ico" />
    <link rel="canonical" href="/blog.erlware.org/post/ecloudedit-erlang-webmachine-and-backbone-js/" />

     <meta name="description" content="To experiment with using a pure client-side rendering talking to an Erlang backend I&amp;rsquo;ve taken James Yu&amp;rsquo;s CloudEdit tutorial an app written with Back" /> 

     
    
    <meta name="twitter:card" content="summary"/>
    
 
    <meta name="twitter:title" content="eCloudEdit: Erlang, Webmachine and Backbone.js"/>
    <meta name="twitter:description" content="To experiment with using a pure client-side rendering talking to an Erlang backend I&amp;rsquo;ve taken James Yu&amp;rsquo;s CloudEdit tutorial an app written with Back"/>
    <meta name="twitter:url" content="/blog.erlware.org/post/ecloudedit-erlang-webmachine-and-backbone-js/" />
    <meta name="twitter:site" content="@"/>

    <meta property="og:site_name" content="Erlware Blog" />
    <meta property="og:title" content="eCloudEdit: Erlang, Webmachine and Backbone.js &middot; Erlware Blog" />
    <meta property="og:url" content="/blog.erlware.org/post/ecloudedit-erlang-webmachine-and-backbone-js/" />
    

    <meta property="og:type" content="article" />
    <meta property="og:description" content="To experiment with using a pure client-side rendering talking to an Erlang backend I&amp;rsquo;ve taken James Yu&amp;rsquo;s CloudEdit tutorial an app written with Back" />

    <meta property="article:published_time" content="2011-02-09T09:10:43Z" />
    <meta property="article:tag" content="Backbone.js" /><meta property="article:tag" content="CouchDB" /><meta property="article:tag" content="Erlang" /><meta property="article:tag" content="Javascript" /><meta property="article:tag" content="MVC" /><meta property="article:tag" content="Web" /><meta property="article:tag" content="Webmachine" />


    <meta name="generator" content="Hugo 0.53" />

    <!-- Stylesheets -->
    <link rel="stylesheet" type="text/css" href="/blog.erlware.org/built/screen.css" /> 
    <link rel="stylesheet" type="text/css" href="/blog.erlware.org/css/casper-two.css" /> 
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" />
    

     

</head>


<body class="ctsingle">

  <div class="site-wrapper"> 

<header class="site-header outer "  >
  <div class="inner">
    <div class="site-header-content">
      <h1 class="site-title">
        <img class="site-logo" src="/blog.erlware.org/img/logo.png" alt="Erlware Blog" />
       </h1>
        <h2 class="site-description">Erlang tools and packaging </h2>
    </div>

    <nav class="site-nav">
      <div class="site-nav-left"><ul class="nav" role="menu">
        
        
        
            <li class="" role="menuitem">
              <a href="/blog.erlware.org/">Home</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/blog.erlware.org/about">About</a>
            </li>
        
      </ul></div>

      <div class="site-nav-right">
        <div class="social-links">
                    

                    

                    <a class="social-link" href="https://github.com/erlware" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>

                    

                    
        </div>  
            
      </div>

    </nav>  

  </div>
</header>


<main id="site-main" class="site-main outer" role="main">
  <div class="inner">
    
    <div class="post-feed">
      <article class="post-card post"> 
    
    <a class="post-card-image-link" href="/blog.erlware.org/post/ecloudedit-erlang-webmachine-and-backbone-js/">
      <div class="post-card-image" style="background-image: url(/blog.erlware.org/defimg/7.jpg)"></div>
    </a>    
    

    <div class="post-card-content">
      <a class="post-card-content-link" href="/blog.erlware.org/post/ecloudedit-erlang-webmachine-and-backbone-js/">
          <header class="post-card-header">
              <span class="post-card-tags">
              #Backbone.js 
              #CouchDB 
              #Erlang 
              #Javascript 
              #MVC 
              #Web 
              #Webmachine  </span>
              
              <h2 class="post-card-title">eCloudEdit: Erlang, Webmachine and Backbone.js</h2>
          </header>
      </a>
      <section class="post-card-excerpt" style="padding: 0 25px;">
          <p>To experiment with using a pure client-side rendering talking to an <a href="http://www.erlang.org" title="Erlang">Erlang</a> backend I&rsquo;ve taken <a href="http://www.jamesyu.org/2011/01/27/cloudedit-a-backbone-js-tutorial-by-example/">James Yu&rsquo;s CloudEdit tutorial</a> an app written with <a href="http://documentcloud.github.com/backbone/">Backbone.js</a> and <a href="http://rubyonrails.org/">Rails</a> and converted the backend to use <a href="http://webmachine.basho.com/">Webmachine</a> and <a href="http://couchdb.apache.org/">CouchDB</a>. You can see eCloudEdit in action <a href="http://erlware.org:8080">here</a>. The Backbone.js code is the same so to understand that please see James&rsquo; post, here I&rsquo;ll describe the Erlang backend.</p>

<p>To begin with we setup two applications, one for handling the web interaction and a second for handling the database interaction. We end up with this directory layout:<br />
<pre style="color:#bebebe;background-color:#262626;overflow:auto;padding:5px;">  |-eCloudEdit<br />
   |-bin<br />
   |-config<br />
   |-doc<br />
   |-lib<br />
   |&mdash;ece_db<br />
   |&mdash;&ndash;doc<br />
   |&mdash;&ndash;ebin<br />
   |&mdash;&ndash;include<br />
   |&mdash;&ndash;src<br />
   |&mdash;ece_web<br />
   |&mdash;&ndash;doc<br />
   |&mdash;&ndash;ebin<br />
   |&mdash;&ndash;include<br />
   |&mdash;&ndash;priv<br />
   |&mdash;&mdash;-images<br />
   |&mdash;&mdash;-javascripts<br />
   |&mdash;&mdash;&mdash;controllers<br />
   |&mdash;&mdash;&mdash;models<br />
   |&mdash;&mdash;&mdash;views<br />
   |&mdash;&mdash;-stylesheets<br />
   |&mdash;&ndash;src</pre><br />
Under ece_web/priv is where all the html and Javascript from CloudEdit is placed, with nothing changed. To serve up the static content through Webmachine we use this <a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_static.erl">resource</a> which we won&rsquo;t worry about in this article. Lets look at how webmachine deciced where to route requests. This is handled by a set of dispatch rules that are passed into Webmachine on startup. We can see how this is done by looking at ece_web_sup and how the supervisor loads Webmachine:</p>

<p>[](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_web_sup.erl">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_web_sup.erl</a>)</p>

<p>[](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_web_sup.erl">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_web_sup.erl</a>)</p>

<p>[<br />
<pre style="color:#bebebe;background-color:#262626;overflow:auto;padding:5px;"><span style="color:#66d9ef;">-spec</span> <span style="color:#66d9ef;">init</span>(<span style="color:#b0c4de;">list</span>()) -&gt; {<span style="color:#7fffd4;">ok</span>, {<span style="color:# fd971f;">SupFlags</span>::<span style="color:#66d9ef;">any</span>(), [<span style="color:# fd971f;">ChildSpec</span>::<span style="color:#66d9ef;">any</span>()]}} |<br />
                          <span style="color:#7fffd4;">ignore</span> | {<span style="color:#7fffd4;">error</span>, <span style="color:# fd971f;">Reason</span>::<span style="color:#66d9ef;">any</span>()}.<br />
<span style="color:# a6e22e;">init</span>([]) -&gt;<br />
    <span style="color:# fd971f;">WebChild</span> = {<span style="color:#7fffd4;">webmachine_mochiweb</span>,<br />
                {<span style="color:#7fffd4;">webmachine_mochiweb</span>, <span style="color:#7fffd4;">start</span>, [<span style="color:#66d9ef;">config</span>()]},<br />
                <span style="color:#7fffd4;">permanent</span>, 5000, <span style="color:#7fffd4;">worker</span>, <span style="color:#7fffd4;">dynamic</span>},</p>

<pre><code>&lt;span style=&quot;color:# fd971f;&quot;&gt;RestartStrategy&lt;/span&gt; = &lt;span style=&quot;color:#7fffd4;&quot;&gt;one_for_one&lt;/span&gt;,  
&lt;span style=&quot;color:# fd971f;&quot;&gt;MaxRestarts&lt;/span&gt; = 3,  
&lt;span style=&quot;color:# fd971f;&quot;&gt;MaxSecondsBetweenRestarts&lt;/span&gt; = 10,  
&lt;span style=&quot;color:# fd971f;&quot;&gt;SupFlags&lt;/span&gt; = {&lt;span style=&quot;color:# fd971f;&quot;&gt;RestartStrategy&lt;/span&gt;, &lt;span style=&quot;color:# fd971f;&quot;&gt;MaxRestarts&lt;/span&gt;, &lt;span style=&quot;color:# fd971f;&quot;&gt;MaxSecondsBetweenRestarts&lt;/span&gt;},  

{&lt;span style=&quot;color:#7fffd4;&quot;&gt;ok&lt;/span&gt;, {&lt;span style=&quot;color:# fd971f;&quot;&gt;SupFlags&lt;/span&gt; , [&lt;span style=&quot;color:# fd971f;&quot;&gt;WebChild&lt;/span&gt;]}}.  
</code></pre>

<p><span style="color:# a6e22e;">config</span>() -&gt;<br />
    {<span style="color:#7fffd4;">ok</span>, <span style="color:# fd971f;">IP</span>} = <span style="color:#66d9ef;">application</span>:<span style="color:#66d9ef;">get_env</span>(<span style="color:#7fffd4;">webmachine_ip</span>),<br />
    {<span style="color:#7fffd4;">ok</span>, <span style="color:# fd971f;">Port</span>} = <span style="color:#66d9ef;">application</span>:<span style="color:#66d9ef;">get_env</span>(<span style="color:#7fffd4;">webmachine_port</span>),<br />
    {<span style="color:#7fffd4;">ok</span>, <span style="color:# fd971f;">App</span>}= <span style="color:#66d9ef;">application</span>:<span style="color:#66d9ef;">get_application</span>(),<br />
    <span style="color:# fd971f;">LogDir</span> = <span style="color:#66d9ef;">code</span>:<span style="color:#66d9ef;">priv_dir</span>(<span style="color:# fd971f;">App</span>) <span style="color:#ff0000;">++</span> <span style="color:#e6db74;">&rdquo;/logs&rdquo;</span>,<br />
    {<span style="color:#7fffd4;">ok</span>, <span style="color:# fd971f;">Dispatch</span>} = <span style="color:#66d9ef;">file</span>:<span style="color:#66d9ef;">consult</span>(<span style="color:#66d9ef;">filename</span>:<span style="color:#66d9ef;">join</span>([<span style="color:#66d9ef;">code</span>:<span style="color:#66d9ef;">priv_dir</span>(<span style="color:# fd971f;">App</span>), <span style="color:#e6db74;">&ldquo;dispatch&rdquo;</span>])),</p>

<pre><code>[{&lt;span style=&quot;color:#7fffd4;&quot;&gt;ip&lt;/span&gt;, &lt;span style=&quot;color:# fd971f;&quot;&gt;IP&lt;/span&gt;},  
 {&lt;span style=&quot;color:#7fffd4;&quot;&gt;port&lt;/span&gt;, &lt;span style=&quot;color:# fd971f;&quot;&gt;Port&lt;/span&gt;},  
 {&lt;span style=&quot;color:#7fffd4;&quot;&gt;log_dir&lt;/span&gt;, &lt;span style=&quot;color:# fd971f;&quot;&gt;LogDir&lt;/span&gt;},  
 {&lt;span style=&quot;color:#7fffd4;&quot;&gt;backlog&lt;/span&gt;, 128},  
 {&lt;span style=&quot;color:#7fffd4;&quot;&gt;dispatch&lt;/span&gt;, &lt;span style=&quot;color:# fd971f;&quot;&gt;Dispatch&lt;/span&gt;}].&lt;/pre&gt;  
</code></pre>

<p>](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_web_sup.erl">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_web_sup.erl</a>)</p>

<p>[](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_web_sup.erl">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_web_sup.erl</a>)</p>

<p>[](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_web_sup.erl">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_web_sup.erl</a>)</p>

<p>The dispatch terms are loaded from a file <em>dispatch</em> in the application&rsquo;s priv directory. For this app the dispatch file contains:</p>

<p>[](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/priv/dispatch">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/priv/dispatch</a>)</p>

<p>[](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/priv/dispatch">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/priv/dispatch</a>)</p>

<p><a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/priv/dispatch"><br />
<pre style="color:#bebebe;background-color:#262626;overflow:auto;padding:5px;"><span style="background-color:#3e3d32;">{</span>[<span style="color:#e6db74;">&ldquo;documents&rdquo;</span>, <span style="color:#7fffd4;">id</span>], <span style="color:#7fffd4;">ece_resource_documents</span>, []<span style="background-color:#3e3d32;">}</span>.<br />
{[<span style="color:#e6db74;">&ldquo;documents&rdquo;</span>], <span style="color:#7fffd4;">ece_resource_documents</span>, []}.<br />
{[<span style="color:#7fffd4;">&lsquo;*&rsquo;</span>], <span style="color:#7fffd4;">ece_resource_static</span>, []}.</pre><br />
</a></p>

<p>[](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/priv/dispatch">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/priv/dispatch</a>)</p>

<p>[](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/priv/dispatch">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/priv/dispatch</a>)</p>

<p>There are two resources, one for handling the requests for creating, updating and viewing documents and one for serving up all other requests (static html, js and css files). The first rule matches paths like, <em>/documents/foo</em>, <em>id</em> is set to <em>foo</em> and the request is sent to the documents resource. If there is nothing after <em>/documents</em> it is still sent to the documents resource but there is no <em>id</em>.</p>

<p>Webmachine is essentially a REST toolkit. You build resources by defining functions that handle the different possible HTTP requests. For this webapp we&rsquo;ll only be dealing with GET, POST and PUT. GET is used if we&rsquo;d like to retrieve information on documents, POST is for creating a new document and PUT is for updating a document.</p>

<p>[](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl</a>)</p>

<p>[](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl</a>)</p>

<p>[<br />
<pre style="color:#bebebe;background-color:#262626;overflow:auto;padding:5px;"><span style="color:#66d9ef;">-record</span>(<span style="color:#66d9ef;">ctx</span>, {<span style="color:#7fffd4;">db</span>}).</p>

<p><span style="color:# a6e22e;">init</span>([]) -&gt;<br />
    {<span style="color:#7fffd4;">ok</span>, <span style="color:# fd971f;">PID</span>} = <span style="color:#66d9ef;">ece_db_sup</span>:<span style="color:#66d9ef;">start_child</span>(),<br />
    {<span style="color:#7fffd4;">ok</span>, #<span style="color:#66d9ef;">ctx</span>{<span style="color:#7fffd4;">db</span>=<span style="color:# fd971f;">PID</span>}}.</p>

<p><span style="color:# a6e22e;">allowed_methods</span>(<span style="color:# fd971f;">ReqData</span>, <span style="color:# fd971f;">Ctx</span>) -&gt;<br />
    {[<span style="color:#7fffd4;">&lsquo;HEAD&rsquo;</span>, <span style="color:#7fffd4;">&lsquo;GET&rsquo;</span>, <span style="color:#7fffd4;">&lsquo;POST&rsquo;</span>, <span style="color:#7fffd4;">&lsquo;PUT&rsquo;</span>], <span style="color:# fd971f;">ReqData</span>, <span style="color:# fd971f;">Ctx</span>}.</p>

<p><span style="color:# a6e22e;">content_types_accepted</span>(<span style="color:# fd971f;">ReqData</span>, <span style="color:# fd971f;">Ctx</span>) -&gt;<br />
    {[{<span style="color:#e6db74;">&ldquo;application/json&rdquo;</span>, <span style="color:#7fffd4;">from_json</span>}], <span style="color:# fd971f;">ReqData</span>, <span style="color:# fd971f;">Ctx</span>}.</p>

<p><span style="color:# a6e22e;">content_types_provided</span>(<span style="color:# fd971f;">ReqData</span>, <span style="color:# fd971f;">Ctx</span>) -&gt;<br />
    {[{<span style="color:#e6db74;">&ldquo;application/json&rdquo;</span>, <span style="color:#7fffd4;">to_json</span>}], <span style="color:# fd971f;">ReqData</span>, <span style="color:# fd971f;">Ctx</span>}.</p>

<p><span style="color:# a6e22e;">finish_request</span>(<span style="color:# fd971f;">ReqData</span>, <span style="color:# fd971f;">Ctx</span>) -&gt;<br />
    <span style="color:#66d9ef;">ece_db_sup</span>:<span style="color:#66d9ef;">terminate_child</span>(<span style="color:# fd971f;">Ctx</span>#<span style="color:#66d9ef;">ctx</span>.<span style="color:#7fffd4;">db</span>),<br />
    {<span style="color:#7fffd4;">true</span>, <span style="color:# fd971f;">ReqData</span>, <span style="color:# fd971f;">Ctx</span>}.</pre><br />
](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl</a>)</p>

<p>[](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl</a>)</p>

<p>[](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl</a>)</p>

<p>To handle GET requests we implemented the _to<em>json</em> function we specified in _content_types<em>provided</em> to handle GET requests for json data.</p>

<p>[](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl</a>)</p>

<p>[](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl</a>)</p>

<p><a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl"><br />
<pre style="color:#bebebe;background-color:#262626;overflow:auto;padding:5px;"><span style="color:# a6e22e;">to_json</span>(<span style="color:# fd971f;">ReqData</span>, <span style="color:# fd971f;">Ctx</span>) -&gt;<br />
    <span style="color:#f92672;">case</span> <span style="color:#66d9ef;">wrq</span>:<span style="color:#66d9ef;">path_info</span>(<span style="color:#7fffd4;">id</span>, <span style="color:# fd971f;">ReqData</span>) <span style="color:#f92672;">of</span><br />
        <span style="color:#7fffd4;">undefined</span> -&gt;<br />
            <span style="color:# fd971f;">All</span> = <span style="color:#66d9ef;">ece_db</span>:<span style="color:#66d9ef;">all</span>(<span style="color:# fd971f;">Ctx</span>#<span style="color:#66d9ef;">ctx</span>.<span style="color:#7fffd4;">db</span>),<br />
            {<span style="color:# fd971f;">All</span>, <span style="color:# fd971f;">ReqData</span>, <span style="color:# fd971f;">Ctx</span>};<br />
        <span style="color:# fd971f;">ID</span> -&gt;<br />
            <span style="color:# fd971f;">JsonDoc</span> = <span style="color:#66d9ef;">ece_db</span>:<span style="color:#66d9ef;">find</span>(<span style="color:# fd971f;">Ctx</span>#<span style="color:#66d9ef;">ctx</span>.<span style="color:#7fffd4;">db</span>, <span style="color:# fd971f;">ID</span>),<br />
            {<span style="color:# fd971f;">JsonDoc</span>, <span style="color:# fd971f;">ReqData</span>, <span style="color:# fd971f;">Ctx</span>}<br />
    <span style="color:#f92672;">end</span>.</pre><br />
</a></p>

<p>[](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl</a>)</p>

<p>[](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl</a>)</p>

<p>_wrq:path<em>info</em> is used to find the value of <em>id</em>, which we set in the dispatch file, if it is <em>undefined</em> we know the request is for all documents, while if it has a value we know to find the contents of the document with that id and return its contents. We&rsquo;ll see the content of _ece<em>db:all/1</em> and _ece<em>db:find/2</em> in the next article. Just know they both return JSON data structures.</p>

<p>Now we must support POST for creating documents or we have nothing to return to a GET request.</p>

<p>[](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl</a>)</p>

<p>[](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl</a>)</p>

<p><a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl"><br />
<pre style="color:#bebebe;background-color:#262626;overflow:auto;padding:5px;"><span style="color:# a6e22e;">process<em>post</span>(<span style="color:# fd971f;">ReqData</span>, <span style="color:# fd971f;">Ctx</span>) -&gt;<br />
    [{<span style="color:# fd971f;">JsonDoc</span>, <span style="color:# fd971f;"></em></span>}] = <span style="color:#66d9ef;">mochiweb_util</span>:<span style="color:#66d9ef;">parse_qs</span>(<span style="color:#66d9ef;">wrq</span>:<span style="color:#66d9ef;">req_body</span>(<span style="color:# fd971f;">ReqData</span>)),<br />
    {<span style="color:#7fffd4;">struct</span>, <span style="color:# fd971f;">Doc</span>} = <span style="color:#66d9ef;">mochijson2</span>:<span style="color:#66d9ef;">decode</span>(<span style="color:# fd971f;">JsonDoc</span>),<br />
    <span style="color:# fd971f;">NewDoc</span> = <span style="color:#66d9ef;">ece_db</span>:<span style="color:#66d9ef;">create</span>(<span style="color:# fd971f;">Ctx</span>#<span style="color:#66d9ef;">ctx</span>.<span style="color:#7fffd4;">db</span>, {<span style="color:# fd971f;">Doc</span>}),<br />
    <span style="color:# fd971f;">ReqData2</span> = <span style="color:#66d9ef;">wrq</span>:<span style="color:#66d9ef;">set_resp_body</span>(<span style="color:# fd971f;">NewDoc</span>, <span style="color:# fd971f;">ReqData</span>),<br />
    {<span style="color:#7fffd4;">true</span>, <span style="color:# fd971f;">ReqData2</span>, <span style="color:# fd971f;">Ctx</span>}.</pre><br />
</a></p>

<p>[](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl</a>)</p>

<p>[](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl</a>)</p>

<p>_wrq:req<em>body/1</em> returns the contents of the body sent in the HTTP request. Here it is the conents of the document to store. We decode it to an Erlang data structure and pass it to the _ece<em>db</em> app for inserting into the database. After inserting to the database the <em>create/2</em> function returns the new document with a new element id (in this case generated by CouchDB). This is required so we know the document&rsquo;s id which is used by the Backbone.js frontend. In order to return it from the POST request we must set response body to the contents of the document with _wrq:set_resp<em>body/2</em></p>

<p>Lastly, updating documents requires support for PUT. In _contents_type<em>accepted/2</em> we&rsquo;ve specified that PUT requests with JSON content is sent to the function _from<em>json/2</em>:</p>

<p>[](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl</a>)</p>

<p>[](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl</a>)</p>

<p><a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl"><br />
<pre style="color:#bebebe;background-color:#262626;overflow:auto;padding:5px;"><span style="color:# a6e22e;">from_json</span>(<span style="color:# fd971f;">ReqData</span>, <span style="color:# fd971f;">Ctx</span>) -&gt;<br />
    <span style="color:#f92672;">case</span> <span style="color:#66d9ef;">wrq</span>:<span style="color:#66d9ef;">path_info</span>(<span style="color:#7fffd4;">id</span>, <span style="color:# fd971f;">ReqData</span>) <span style="color:#f92672;">of</span><br />
        <span style="color:#7fffd4;">undefined</span> -&gt;<br />
            {<span style="color:#7fffd4;">false</span>, <span style="color:# fd971f;">ReqData</span>, <span style="color:# fd971f;">Ctx</span>};<br />
        <span style="color:# fd971f;">ID</span> -&gt;<br />
            <span style="color:# fd971f;">JsonDoc</span> = <span style="color:#66d9ef;">wrq</span>:<span style="color:#66d9ef;">req_body</span>(<span style="color:# fd971f;">ReqData</span>),<br />
            {<span style="color:#7fffd4;">struct</span>, <span style="color:# fd971f;">Doc</span>} = <span style="color:#66d9ef;">mochijson2</span>:<span style="color:#66d9ef;">decode</span>(<span style="color:# fd971f;">JsonDoc</span>),<br />
            <span style="color:# fd971f;">NewDoc</span> = <span style="color:#66d9ef;">ece_db</span>:<span style="color:#66d9ef;">update</span>(<span style="color:# fd971f;">Ctx</span>#<span style="color:#66d9ef;">ctx</span>.<span style="color:#7fffd4;">db</span>, <span style="color:# fd971f;">ID</span>, <span style="color:# fd971f;">Doc</span>),<br />
            <span style="color:# fd971f;">ReqData2</span> = <span style="color:#66d9ef;">wrq</span>:<span style="color:#66d9ef;">set_resp_body</span>(<span style="color:# fd971f;">NewDoc</span>, <span style="color:# fd971f;">ReqData</span>),<br />
            {<span style="color:#7fffd4;">true</span>, <span style="color:# fd971f;">ReqData2</span>, <span style="color:# fd971f;">Ctx</span>}<br />
    <span style="color:#f92672;">end</span>.</pre><br />
</a></p>

<p>[](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl</a>)</p>

<p>[](<a href="https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl">https://github.com/tsloughter/eCloudEdit/blob/master/lib/ece_web/src/ece_resource_documents.erl</a>)</p>

<p>If this request was not routed through the first rule in our dispatch file it does not have an <em>id</em> and thus can not be an update. When this happens we return false so the frontend is aware something has gone wrong. For requests containing an <em>id</em> we pass the contents of the requests body to _ece<em>db</em>&rsquo;s <em>update/2</em> function.</p>

<p>In the next post I&rsquo;ll show how _ece<em>db</em> is implemented with <a href="http://benoitc.github.com/couchbeam/">Couchbeam</a> for reading and writing the documents to CouchDB on <a href="http://www.cloudant.com">Cloudant</a>.</p>

      </section>

      <footer class="post-card-meta">
          <img class="author-profile-image" src="/blog.erlware.org/" alt="Author" />
          <span class="post-card-author"><a href="/">Tristan Sloughter</a></span>
      </footer>
    </div>
</article>
    </div>

    <nav class="pagination" role="navigation">
      
          <a class="newer-posts" href="/blog.erlware.org/post/ecloudedit-part-2-couchdb/">&larr; <span class="hide">Next Post</span></a>
      
      <span class="page-number">&nbsp;</span>
      
    </nav>

    
    
    

  </div>
</main>



<footer class="site-footer outer">
  <div class="site-footer-content inner">
    <section class="copyright" style="line-height: 1.3em;">
      <a href="/"></a>  <br>
      
    </section>
    <nav class="site-footer-nav">
        <a href="/">Latest Posts</a>
        
        
        <a href="https://github.com/erlware" target="_blank" rel="noopener">Github</a>
        
        
    </nav>  
  </div>
</footer>

</div>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script type="text/javascript" src="//code.jquery.com/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="/blog.erlware.org/js/jquery.fitvids.js"></script>

<script>hljs.initHighlightingOnLoad();</script>




</body></html>
