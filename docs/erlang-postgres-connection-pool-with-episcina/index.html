<!DOCTYPE html>
<html lang="en-us" />
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>Erlang Postgres Connection Pool with Episcina &middot; Erlware Blog</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="canonical" href="/erlang-postgres-connection-pool-with-episcina/" />

     <meta name="description" content="Almost exactly a year ago I was looking to merge the many forks of Will Glozer&amp;rsquo;s Postgres client for use in a project at Heroku. Instead Semiocast release" /> 

     
    
    <meta name="twitter:card" content="summary"/>
    
 
    <meta name="twitter:title" content="Erlang Postgres Connection Pool with Episcina"/>
    <meta name="twitter:description" content="Almost exactly a year ago I was looking to merge the many forks of Will Glozer&amp;rsquo;s Postgres client for use in a project at Heroku. Instead Semiocast release"/>
    <meta name="twitter:url" content="/erlang-postgres-connection-pool-with-episcina/" />
    <meta name="twitter:site" content="@"/>

    <meta property="og:site_name" content="Erlware Blog" />
    <meta property="og:title" content="Erlang Postgres Connection Pool with Episcina &middot; Erlware Blog" />
    <meta property="og:url" content="/erlang-postgres-connection-pool-with-episcina/" />
    

    <meta property="og:type" content="article" />
    <meta property="og:description" content="Almost exactly a year ago I was looking to merge the many forks of Will Glozer&amp;rsquo;s Postgres client for use in a project at Heroku. Instead Semiocast release" />

    <meta property="article:published_time" content="2014-05-05T02:41:52Z" />
    <meta property="article:tag" content="Databases" /><meta property="article:tag" content="Erlang" /><meta property="article:tag" content="Postgres" />


    <meta name="generator" content="Hugo 0.53" />

    <!-- Stylesheets -->
    <link rel="stylesheet" type="text/css" href="/built/screen.css" /> 
    <link rel="stylesheet" type="text/css" href="/css/casper-two.css" /> 
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" />
    

     

</head>


<body class="ctsingle">

<div class="site-wrapper"> 

<header class="site-header outer "  >
  <div class="inner">
    <div class="site-header-content">
      <h1 class="site-title">
        <img class="site-logo" src="/img/logo.png" alt="Erlware Blog" />
       </h1>
        <h2 class="site-description">Erlang tools and packaging </h2>
    </div>

    <nav class="site-nav">
      <div class="site-nav-left"><ul class="nav" role="menu">
        
        
        
            <li class="" role="menuitem">
              <a href="/">Home</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/about">About</a>
            </li>
        
      </ul></div>

      <div class="site-nav-right">
        <div class="social-links">
                    

                    

                    <a class="social-link" href="https://github.com/erlware" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>

                    

                    
        </div>  
            
      </div>

    </nav>  

  </div>
</header>



<main id="site-main" class="site-main outer" role="main">
  <div class="inner">
  	
    <div class="post-feed">
      <article class="post-card post"> 
    
    <a class="post-card-image-link" href="/erlang-postgres-connection-pool-with-episcina/">
      <div class="post-card-image" style="background-image: url(/defimg/7.jpg)"></div>
    </a>    
    

    <div class="post-card-content">
      <a class="post-card-content-link" href="/erlang-postgres-connection-pool-with-episcina/">
          <header class="post-card-header">
              <span class="post-card-tags">
              #Databases 
              #Erlang 
              #Postgres  </span>
              
              <h2 class="post-card-title">Erlang Postgres Connection Pool with Episcina</h2>
          </header>
      </a>
      <section class="post-card-excerpt" style="padding: 0 25px;">
          <p>Almost exactly a year ago I was looking to merge the many forks of <a href="https://github.com/wg/epgsql">Will Glozer&rsquo;s Postgres client</a> for use in a project at Heroku. Instead <a href="https://github.com/semiocast/">Semiocast</a> released their <a href="https://github.com/semiocast/pgsql">client</a>, I gave it a try and never looked back. (But note that David Welton, a braver person than me, is working on merging the forks of <a href="https://github.com/davidw/epgsql">epgsql</a> at this time). I found Semiocast&rsquo;s client to be clean, stable and I liked the interface better.</p>

<p>At the same time I was in the need of a connection pooler. Many have relied on <a href="https://github.com/devinus/poolboy">poolboy</a> or <a href="https://github.com/seth/pooler">pooler</a> for this purpose but neither actually fits the use case of connection pooling that well. Luckily Eric and Jordan were in the need at the same time and created the Erlware project <a href="https://github.com/erlware/episcina">episcina</a>, which they based off of Joseph Wecker&rsquo;s fork of Will Glozer&rsquo;s <a href="https://github.com/josephwecker/epgsql_pool">epgsql pool</a>. Episcina differs in that it is purely for connection pooling, it is not for pooling workers and it is not for pooling generic processes.</p>

<p>Here I&rsquo;ll show how I combined the two in a <a href="https://github.com/tsloughter/postgres_pool_example">simple example</a>.</p>

<p>To start we have a <code>sys.config</code> file to configure episcina:<br />
<pre style="line-height:1.3em;font-family:monospace;color:#f8f8f2;background-color:#272822;">{<span style="color:#f8f8f2;background-color:#272822;">episcina</span>, [{<span style="color:#f8f8f2;background-color:#272822;">pools</span>, [{<span style="color:#f8f8f2;background-color:#272822;">primary</span>,<br />
                        [{<span style="color:#f8f8f2;background-color:#272822;">size</span>, 10},<br />
                         {<span style="color:#f8f8f2;background-color:#272822;">timeout</span>, 10000},<br />
                         {<span style="color:#f8f8f2;background-color:#272822;">connect_provider</span>, {<span style="color:#f8f8f2;background-color:#272822;">pp_db</span>, <span style="color:#f8f8f2;background-color:#272822;">open</span>,<br />
                                             [[{<span style="color:#f8f8f2;background-color:#272822;">host</span>, <span style="color:#e6db74;">&ldquo;localhost&rdquo;</span>}<br />
                                              ,{<span style="color:#f8f8f2;background-color:#272822;">database</span>, <span style="color:#e6db74;">&ldquo;postgres_pool&rdquo;</span>}<br />
                                              ,{<span style="color:#f8f8f2;background-color:#272822;">port</span>, 5432}<br />
                                              ,{<span style="color:#f8f8f2;background-color:#272822;">user</span>, <span style="color:#e6db74;">&ldquo;postgres&rdquo;</span>}<br />
                                              ,{<span style="color:#f8f8f2;background-color:#272822;">password</span>, <span style="color:#e6db74;">&ldquo;password&rdquo;</span>}]]}},<br />
                         {<span style="color:#f8f8f2;background-color:#272822;">close_provider</span>, {<span style="color:#f8f8f2;background-color:#272822;">pp_db</span>, <span style="color:#f8f8f2;background-color:#272822;">close</span>, []}}]}]<br />
              }<br />
             ]<br />
}</p>

<p></pre><br />
A key thing to note here is the connect and close providers are function calls to modules within the project and not the Postgres client. Episcina requires a return value of <code>{ok, pid()}</code> and the Semiocast client returns <code>{pgsql_connection, pid()}</code>, so we wrap the connection calls to get around that:<br />
<pre style="line-height:1.3em;font-family:monospace;color:#f8f8f2;background-color:#272822;"><span style="color:#f92672;">-spec</span> <span style="color:#66d9ef;">get_connection</span>(<span style="color:#66d9ef;">atom</span>()) <span style="color:#a6e22e;">-&gt;</span> {<span style="color:#f8f8f2;background-color:#272822;">pgsql_connection</span>, <span style="color:#66d9ef;">pid</span>()} | {<span style="color:#f8f8f2;background-color:#272822;">error</span>, <span style="color:#f8f8f2;background-color:#272822;">timeout</span>}.<br />
<span style="color:#a6e22e;">get_connection</span>(<span style="color:#fd971f;">Pool</span>) <span style="color:#a6e22e;">-&gt;</span><br />
    <span style="color:#f92672;">case</span> <span style="color:#66d9ef;">episcina</span>:<span style="color:#66d9ef;">get_connection</span>(<span style="color:#fd971f;">Pool</span>) <span style="color:#f92672;">of</span><br />
        {<span style="color:#f8f8f2;background-color:#272822;">ok</span>, <span style="color:#fd971f;">Pid</span>} <span style="color:#a6e22e;">-&gt;</span><br />
            {<span style="color:#f8f8f2;background-color:#272822;">pgsql_connection</span>, <span style="color:#fd971f;">Pid</span>};<br />
        {<span style="color:#f8f8f2;background-color:#272822;">error</span>, <span style="color:#f8f8f2;background-color:#272822;">timeout</span>} <span style="color:#a6e22e;">-&gt;</span><br />
            {<span style="color:#f8f8f2;background-color:#272822;">error</span>, <span style="color:#f8f8f2;background-color:#272822;">timeout</span>}<br />
    <span style="color:#f92672;">end</span>.</p>

<p><span style="color:#f92672;">-spec</span> <span style="color:#66d9ef;">return_connection</span>(<span style="color:#66d9ef;">atom</span>(), {<span style="color:#f8f8f2;background-color:#272822;">pgsql_connection</span>, <span style="color:#66d9ef;">pid</span>()}) <span style="color:#a6e22e;">-&gt;</span> <span style="color:#f8f8f2;background-color:#272822;">ok</span>.<br />
<span style="color:#a6e22e;">return_connection</span>(<span style="color:#fd971f;">Pool</span>, {<span style="color:#f8f8f2;background-color:#272822;">pgsql_connection</span>, <span style="color:#fd971f;">Pid</span>}) <span style="color:#a6e22e;">-&gt;</span><br />
    <span style="color:#66d9ef;">episcina</span>:<span style="color:#66d9ef;">return_connection</span>(<span style="color:#fd971f;">Pool</span>, <span style="color:#fd971f;">Pid</span>).</p>

<p><span style="color:#f92672;">-spec</span> <span style="color:#66d9ef;">open</span>(<span style="color:#66d9ef;">list</span>()) <span style="color:#a6e22e;">-&gt;</span> {<span style="color:#f8f8f2;background-color:#272822;">ok</span>, <span style="color:#66d9ef;">pid</span>()}.<br />
<span style="color:#a6e22e;">open</span>(<span style="color:#fd971f;">DBArgs</span>) <span style="color:#a6e22e;">-&gt;</span><br />
    {<span style="color:#f8f8f2;background-color:#272822;">pgsql_connection</span>, <span style="color:#fd971f;">Pid</span>} = <span style="color:#66d9ef;">pgsql_connection</span>:<span style="color:#66d9ef;">open</span>(<span style="color:#fd971f;">DBArgs</span>),<br />
    {<span style="color:#f8f8f2;background-color:#272822;">ok</span>, <span style="color:#fd971f;">Pid</span>}.</p>

<p><span style="color:#f92672;">-spec</span> <span style="color:#66d9ef;">close</span>(<span style="color:#66d9ef;">pid</span>()) <span style="color:#a6e22e;">-&gt;</span> <span style="color:#f8f8f2;background-color:#272822;">ok</span>.<br />
<span style="color:#a6e22e;">close</span>(<span style="color:#fd971f;">Pid</span>) <span style="color:#a6e22e;">-&gt;</span><br />
    <span style="color:#66d9ef;">pgsql_connection</span>:<span style="color:#66d9ef;">close</span>({<span style="color:#f8f8f2;background-color:#272822;">pgsql_connection</span>, <span style="color:#fd971f;">Pid</span>}).<br />
</pre><br />
And here is the query function to get a connection and return it to the pool after completion:<br />
<pre style="line-height:1.3em;font-family:monospace;color:#f8f8f2;background-color:#272822;"><span style="color:#f92672;"><br />
-spec</span> <span style="color:#66d9ef;">query</span>(<span style="color:#66d9ef;">string</span>()) <span style="color:#a6e22e;">-&gt;</span> <span style="color:#66d9ef;">tuple</span>().<br />
<span style="color:#a6e22e;">query</span>(<span style="color:#fd971f;">Query</span>) <span style="color:#a6e22e;">-&gt;</span><br />
    <span style="color:#fd971f;">C</span> = <span style="color:#66d9ef;">get_connection</span>(<span style="color:#f8f8f2;background-color:#272822;">primary</span>),<br />
    <span style="color:#f92672;">try</span><br />
        <span style="color:#66d9ef;">pgsql_connection</span>:<span style="color:#66d9ef;">simple_query</span>(<span style="color:#fd971f;">Query</span>, [], <span style="color:#f8f8f2;background-color:#272822;">infinity</span>, <span style="color:#fd971f;">C</span>)<br />
    <span style="color:#f92672;">after</span><br />
        <span style="color:#66d9ef;">return_connection</span>(<span style="color:#f8f8f2;background-color:#272822;">primary</span>, <span style="color:#fd971f;">C</span>)<br />
    <span style="color:#f92672;">end</span>.<br />
</pre><br />
This example project uses <a href="http://relx.org">relx</a> to build a release which will start episcina on boot:<br />
<pre style="line-height:1.3em;font-family:monospace;color:#f8f8f2;background-color:#272822;">{release, {postgres_pool, &ldquo;0.0.1&rdquo;},<br />
  [postgres_pool]}.</p>

<p>{sys_config, &ldquo;./config/sys.config&rdquo;}.<br />
{dev_mode, true}.</p>

<p>{include_erts, true}.<br />
{extended_start_script, true}.<br />
</pre><br />
Boot the release to an interactive shell and play around:</p>

<pre style="line-height:1.3em;font-family:monospace;color:#f8f8f2;background-color:#272822;">  
λ _rel/bin/postgres_pool console  
(postgres_pool@127.0.0.1)1&gt; pp_db:query("SELECT 1").  
{{select,1},[{1}]}  
</pre>

      </section>

    </div>
</article>
    </div>
    
  </div>
</main>

<footer class="site-footer outer">
  <div class="site-footer-content inner">
    <section class="copyright" style="line-height: 1.3em;">
      <a href="/"></a>  <br>
      
    </section>
    <nav class="site-footer-nav">
        <a href="/">Latest Posts</a>
        
        
        <a href="https://github.com/erlware" target="_blank" rel="noopener">Github</a>
        
        
    </nav>  
  </div>
</footer>

</div><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script type="text/javascript" src="//code.jquery.com/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="/js/jquery.fitvids.js"></script>

<script>hljs.initHighlightingOnLoad();</script>


</body></html>
