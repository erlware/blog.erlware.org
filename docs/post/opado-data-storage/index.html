<!DOCTYPE html>
<html lang="en-us" />
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>OpaDo Data Storage &middot; Erlware Blog</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/blog.erlware.org/favicon.ico" />
    <link rel="canonical" href="/blog.erlware.org/post/opado-data-storage/" />

     <meta name="description" content="OpaDo (a port of the TodoMVC app to Opa) now persists todo items to the Opa database. The new version is up on dotcloud, http://opado-tristan.sloughter.dotcloud" /> 

     
    
    <meta name="twitter:card" content="summary"/>
    
 
    <meta name="twitter:title" content="OpaDo Data Storage"/>
    <meta name="twitter:description" content="OpaDo (a port of the TodoMVC app to Opa) now persists todo items to the Opa database. The new version is up on dotcloud, http://opado-tristan.sloughter.dotcloud"/>
    <meta name="twitter:url" content="/blog.erlware.org/post/opado-data-storage/" />
    <meta name="twitter:site" content="@"/>

    <meta property="og:site_name" content="Erlware Blog" />
    <meta property="og:title" content="OpaDo Data Storage &middot; Erlware Blog" />
    <meta property="og:url" content="/blog.erlware.org/post/opado-data-storage/" />
    

    <meta property="og:type" content="article" />
    <meta property="og:description" content="OpaDo (a port of the TodoMVC app to Opa) now persists todo items to the Opa database. The new version is up on dotcloud, http://opado-tristan.sloughter.dotcloud" />

    <meta property="article:published_time" content="2011-10-06T18:59:55Z" />
    <meta property="article:tag" content="cloud" /><meta property="article:tag" content="dotcloud" /><meta property="article:tag" content="Opa" /><meta property="article:tag" content="Web" />


    <meta name="generator" content="Hugo 0.53" />

    <!-- Stylesheets -->
    <link rel="stylesheet" type="text/css" href="/blog.erlware.org/built/screen.css" /> 
    <link rel="stylesheet" type="text/css" href="/blog.erlware.org/css/casper-two.css" /> 
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" />
    

     

</head>


<body class="ctsingle">

  <div class="site-wrapper"> 

<header class="site-header outer "  >
  <div class="inner">
    <div class="site-header-content">
      <h1 class="site-title">
        <img class="site-logo" src="/blog.erlware.org/img/logo.png" alt="Erlware Blog" />
       </h1>
        <h2 class="site-description">Erlang tools and packaging </h2>
    </div>

    <nav class="site-nav">
      <div class="site-nav-left"><ul class="nav" role="menu">
        
        
        
            <li class="" role="menuitem">
              <a href="/blog.erlware.org/">Home</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/blog.erlware.org/about">About</a>
            </li>
        
      </ul></div>

      <div class="site-nav-right">
        <div class="social-links">
                    

                    

                    <a class="social-link" href="https://github.com/erlware" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>

                    

                    
        </div>  
            
      </div>

    </nav>  

  </div>
</header>


<main id="site-main" class="site-main outer" role="main">
  <div class="inner">
    
    <div class="post-feed">
      <article class="post-card post"> 
    
    <a class="post-card-image-link" href="/blog.erlware.org/post/opado-data-storage/">
      <div class="post-card-image" style="background-image: url(/blog.erlware.org/defimg/5.jpg)"></div>
    </a>    
    

    <div class="post-card-content">
      <a class="post-card-content-link" href="/blog.erlware.org/post/opado-data-storage/">
          <header class="post-card-header">
              <span class="post-card-tags">
              #cloud 
              #dotcloud 
              #Opa 
              #Web  </span>
              
              <h2 class="post-card-title">OpaDo Data Storage</h2>
          </header>
      </a>
      <section class="post-card-excerpt" style="padding: 0 25px;">
          <p><a href="https://github.com/tsloughter/OpaDo">OpaDo</a> (a port of the TodoMVC app to Opa) now persists todo items to the Opa database. The new version is up on <a href="http://www.dotcloud.com">dotcloud</a>, <a href="http://opado-tristan.sloughter.dotcloud.com/">http://opado-tristan.sloughter.dotcloud.com/</a></p>

<p>I&rsquo;ve added a _todo<em>item</em> type which stores the item&rsquo;s value and two other attributes we won&rsquo;t use until the next post when we have user accounts for their own _todo<em>item</em> stores.<br />
<pre style="color:#bebebe;background-color:#262626;"><span style="color:#00ffff;">type</span> <span style="color:#b0c4de;">todo_item =</span> <span style="color:#00ffff;">{</span> user_id <span style="color:#98fb98;">: string</span><br />
                 <span style="color:#00ffff;">;</span> value <span style="color:#98fb98;">: string</span><br />
                 <span style="color:#00ffff;">;</span> created_at <span style="color:#98fb98;">: string</span><br />
                 <span style="color:#00ffff;">}</span></pre><br />
To tell Opa where to store the records we&rsquo;ll create, we provide a path to the Opa db function and set its type. For our todo items we use a <em>stringmap</em> since currently the id&rsquo;s are randomly generated strings (I know, I know, but its just an example!). We can then reference a record in the database with the path /todo_item[some_id_string].<br />
<pre style="color:#bebebe;background-color:#262626;"><span style="color:#00ffff;">db</span> /todo_items <span style="color:#98fb98;">: stringmap(todo_item)</span></pre><br />
Now we can insert _todo<em>item</em>&rsquo;s to this db path as so:<br />
<pre style="color:#bebebe;background-color:#262626;">/todo_items[id] <span style="color:#00ffff;">&lt;-</span> <span style="color:#00ffff;">{</span> <span style="color:#b0c4de;">value=</span>x <span style="color:#b0c4de;">user_id=</span><span style="color:#ffa07a;">&rdquo;&rdquo;</span> <span style="color:#b0c4de;">created_at=</span><span style="color:#ffa07a;">&rdquo;&rdquo;</span> <span style="color:#00ffff;">}</span></pre><br />
For now _user<em>id</em> and _created<em>at</em> are empty, but I&rsquo;ll be updating that when I add user accounts.</p>

<p>Since we are storing each item, we need to populate the list on page load with whats already stored:<br />
<pre style="color:#bebebe;background-color:#262626;"><span style="color:#87cefa;">add_todos</span>() =<br />
  <span style="color:#b0c4de;">items =</span> /todo_items<br />
  <span style="color:#87cefa;">StringMap.iter</span>((x, y <span style="color:#00ffff;">-&gt;</span> <span style="color:#87cefa;">add_todo_to_page</span>(x, y<span style="color:#7fffd4;">.value</span>)), items)</pre><br />
The first line of the function sets the variable items to all the _todo<em>item</em> records in the database. We use <em>StringMap.iter</em> to take each _todo<em>item</em> and add it to the page. The first argument to the anonymous function is the id the item is stored in the database with (the id we will use in the HTML as well) and the second is the actual _todo<em>item</em>, so we take its value field and pass that to the _add_todo_to<em>page</em> function along with the id.</p>

<p>To have the _add<em>todos</em> function when the list element is ready we add an _on<em>ready</em> attribute that will call add_todos:<br />
<pre style="color:#bebebe;background-color:#262626;"><span style="color:#ffa07a;">&lt;</span><span style="color:#00ffff;">ul </span><span style="color:#ffa07a;">id=#todo<em>list onready={</span></em> <span style="color:#00ffff;">-&gt;</span> <span style="color:#87cefa;">add_todos</span>() <span style="color:#ffa07a;">} &gt;&lt;</span><span style="color:#00ffff;">/ul</span><span style="color:#ffa07a;">&gt;</span></pre><br />
Lastly, we want to be able to delete a _todo<em>item</em> from the database:<br />
<pre style="color:#bebebe;background-color:#262626;"><span style="color:#87cefa;">remove_item</span>(id<span style="color:#98fb98;">: string</span>) =<br />
  <span style="color:#00ffff;">do</span> <span style="color:#87cefa;">Dom.remove</span>(<span style="color:#87cefa;">Dom.select_parent_one</span>(#<span style="color:#00ffff;">{</span>id<span style="color:#00ffff;">}</span>))<br />
  <span style="color:#00ffff;">do</span> <span style="color:#87cefa;">Db.remove</span>(@/todo_items[id])<br />
  <span style="color:#87cefa;">update_counts</span>()</p>

<p><span style="color:#87cefa;">remove_all_done</span>() =<br />
  <span style="color:#87cefa;">Dom.iter</span>(x <span style="color:#00ffff;">-&gt;</span> <span style="color:#87cefa;">remove_item</span>(<span style="color:#87cefa;">Dom.get_id</span>(x)), <span style="color:#87cefa;">Dom.select_class</span>(<span style="color:#ffa07a;">&ldquo;done&rdquo;</span>))</pre><br />
The main piece to notice here is _@/todo<em>items[id]</em> in <em>Db.remove()</em>. The @ is saying that we are passing the path itself to <em>remove()</em> and not the value at that path.</p>

<p>Nice and easy! No database to setup or deploy, just Opa. Next time we&rsquo;ll add user accounts, so we don&rsquo;t have to all share the same todo list.</p>

      </section>

      <footer class="post-card-meta">
          <img class="author-profile-image" src="/blog.erlware.org/" alt="Author" />
          <span class="post-card-author"><a href="/">Tristan Sloughter</a></span>
      </footer>
    </div>
</article>
    </div>

    <nav class="pagination" role="navigation">
      
          <a class="newer-posts" href="/blog.erlware.org/post/announcing-erlangdc-an-epic-one-day-erlang-conference-in-the-washington-dc-area/">&larr; <span class="hide">Next Post</span></a>
      
      <span class="page-number">&nbsp;</span>
      
          <a class="older-posts" href="/blog.erlware.org/post/todomvc-in-opa/"><span class="hide">Previous Post</span> &rarr;</a>
      
    </nav>

    
    
    

  </div>
</main>



<footer class="site-footer outer">
  <div class="site-footer-content inner">
    <section class="copyright" style="line-height: 1.3em;">
      <a href="/"></a>  <br>
      
    </section>
    <nav class="site-footer-nav">
        <a href="/">Latest Posts</a>
        
        
        <a href="https://github.com/erlware" target="_blank" rel="noopener">Github</a>
        
        
    </nav>  
  </div>
</footer>

</div>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script type="text/javascript" src="//code.jquery.com/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="/blog.erlware.org/js/jquery.fitvids.js"></script>

<script>hljs.initHighlightingOnLoad();</script>




</body></html>
